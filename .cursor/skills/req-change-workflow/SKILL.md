---
name: req-change-workflow
description: 标准化需求/功能变更流程，避免改需求时混乱与代码崩溃。Use when the user says 改需求、需求变更、调整交互、改功能、重构流程，或变更涉及 manifest/service worker/存储/UI 需可靠验证与回滚。
---

# 需求变更工作流

按顺序执行，**未获用户批准 Step 4 前不写代码**。

## Step 1：澄清变更（锁定范围）

向用户收集并整理成「变更简报」：目标（一句话）、不在范围内（一句话）、验收标准（3–6 条可验证）、必须保留的约束、回滚预期。

## Step 2：确认现状（基线）

从代码中确认当前行为，不依赖记忆。列出：UI 入口、后台/worker、核心模块、存储、manifest/权限。只读必要文件。产出：当前行为摘要 + 相关文件列表及原因。

## Step 3：影响与风险

列出：必须改动的文件及原因、风险（鉴权/存储迁移/并发/缓存/权限/UX 回归）、测试检查点、回滚计划。若动 manifest 或 service_worker，验证计划中需包含「手动重载扩展」。

## Step 4：提出新设计（等用户批准）

描述新流程、状态与失败恢复、不变部分、可观测性。请用户确认：验收标准、变更文件列表、本设计。**用户明确同意（如「同意/按这个做」）后再开始改代码。**

## Step 5：最小化实现

小范围、局部化修改；优先根因修复；集中逻辑、避免散落；必要时加简短 JSDoc 与中文注释说明假设与失败处理。

## Step 6：验证

按回归清单执行；若改过 manifest/service_worker 先重载扩展再测；记录测试项与结果。

## Step 7：文档与决策记录

更新项目文档；写决策日志：为何此设计、放弃的方案、如何回滚。
